// ==UserScript==
// @name         è¥¿å®‰ç”µå­ç§‘æŠ€å¤§å­¦é›¨è¯¾å ‚åˆ·è¯¾ åˆ·é¢˜
// @namespace    http://tampermonkey.net/
// @version      1.2
// @description  å…¨ç¨‹ä»£ç†ï¼è§£æ”¾åŒæ‰‹ï¼
// @author       feifei
// @license      MIT
// @match        https://xidianyjs.yuketang.cn/pro/lms/*/homework/*
// @match        https://xidianyjs.yuketang.cn/pro/lms/*/studycontent
// @match        https://xidianyjs.yuketang.cn/pro/lms/*/video/*
// @require      https://lib.baomitu.com/axios/0.27.2/axios.min.js
// @icon         https://www.google.com/s2/favicons?sz=64&domain=yuketang.cn
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // æ’å…¥htmlå…ƒç´ 
    const html = `<style>
    .xy_main{
        position: fixed;
        top: 0;
        left: 50%;
        min-height: 40px;
        min-width: 300px;
        border-radius: 0 0 12px 12px;
        transform: translateX(-50%);
        background-color: rgb(219, 219, 219);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        text-align: center;
        line-height: 40px;
        padding: 0 12px;
    }
    .xy_main .reward-author{
        width: 100%;
        min-height: 40px;
        position: relative;
    }
    .xy_main .reward-author::after{
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 40px;
        background-color: #dbdbdb;
        transition: 300ms;
        opacity: 0;
    }
    .xy_main:hover .reward-author::after{
        opacity: 1;
    }
    .xy_main:hover .reward-author::before{
        height: 400px;
        max-height: 120vh;
    }
    .learing-iframe-box{
        position: absolute;
        top: 0px;
        left: 70px;
        width: 350px;
        height: auto;
        z-index: 1010;
    }
    .learing-iframe-box .boxs{
        width: 360px;
        height: 240px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .learing-iframe-box .boxs .learing-iframe{
        width: 360px;
        height: 240px;
    }
</style>
<div class="xy_main">
    <div class="title"></div>
    <div class="press"></div>
    <div class="reward-author">æ‰“èµ/è”ç³»ä½œè€…ğŸ</div>
</div>
<div class="learing-iframe-box">
</div>`
    const div = document.createElement("div")
    div.innerHTML = html
    document.body.appendChild(div)
    const showEl = document.querySelector(".title"),
        showEl2 = document.querySelector(".press")

    const url = location.pathname;
    console.log("è„šæœ¬è¿è¡Œ")

    // ä¹ é¢˜ç›®å½•
    const exerciseList = new RegExp(/get_exercise_list\/.+term/)
    // ä¹ é¢˜é¡µé¢
    const homework = new RegExp(/lms\/.+\/homework\//)
    // å­¦ä¹ å†…å®¹
    const studycontent = new RegExp(/lms\/.+\/studycontent/)
    // å­¦ä¹ åˆ—è¡¨
    const studyList = new RegExp(/\/lms\/learn\/course\/chapter.+/)
    // å®Œæˆè¿›åº¦
    const progress = new RegExp(/\lms\/learn\/course\/schedule/)
    // è§†é¢‘æ’­æ”¾
    const videoPlay = new RegExp(/\lms\/.+video\/.+/)
    // è·å–è§†é¢‘é“¾æ¥
    const getVideoUrl = new RegExp(/audiovideo\/playurl/)


    // æˆ¿é—´id
    const classroom_id = +location.pathname.split("/")[4];

    if (homework.test(url)) {
        console.log("ä¹ é¢˜é¡µé¢")
        answerQuestions();
    } else if (studycontent.test(url)) {
        console.log("å­¦ä¹ å†…å®¹")
        studycontentList();
    } else if (videoPlay.test(url)) {
        console.log("è§†é¢‘æ’­æ”¾")
        playVideo();
    }

    // ç­”é¢˜é¡µé¢é€»è¾‘
    function answerQuestions() {
        const API_HEADER = localStorage.getItem("API_HEADER")
        let universityId = null
        if (API_HEADER) {
            universityId = JSON.parse(API_HEADER).school_id;
        } else {
            alert("ç¼ºå°‘è¿è¡Œå¿…è¦å‚æ•°");
            return;
        }
        const ansUrl = `https://xidianyjs.yuketang.cn/mooc-api/v1/lms/exercise/problem_apply/?term=latest&uv_id=${universityId}`

        // é¢˜ç›®å¤„ç†
        async function ans(data) {
            let answ = data.data.problems
            console.log("æ‰€æœ‰é¢˜ç›®", answ)
            for (let key = 0; key < answ.length; key++) {
                const el = answ[key];
                // è¿‡æ»¤å·²ç»ç­”å¯¹çš„é¢˜ç›®
                if (!el.user.is_show_answer) {
                    showEl.innerText = `æ­£åœ¨ç­”é¢˜ [${key + 1}]`
                    if (el.content.Type === "MultipleChoice") {
                        // å¤šé€‰
                        console.log(`[${key + 1}]å¤šé€‰é¢˜ï¼š${el.content.Body}`)
                        showEl2.innerText = ""
                        await goAnas(el.content, true)
                    } else {
                        // å•é€‰
                        console.log(`[${key + 1}]å•é€‰é¢˜ï¼š${el.content.Body}`)
                        showEl2.innerText = ""
                        await goAnas(el.content, false)
                    }
                } else {
                    console.log("é¢˜ç›®å·²ç­”å¯¹")
                }
            }
            console.log("æ‰€æœ‰é¢˜ç›®å·²å®Œæˆ")
            showEl.innerText = "æ‰€æœ‰é¢˜ç›®å·²å®Œæˆ"
            showEl2.innerText = ""
        }

        // ç­”é¢˜
        async function goAnas(data, isMultip) {
            const ansList = ansArr(data.Options, isMultip)
            for (let key = 0; key < ansList.length; key++) {
                await delay(3000);
                const res = await axios.post(ansUrl, {
                    answer: ansList[key],
                    classroom_id,
                    problem_id: data.ProblemID
                }, { headers: { 'xtbz': 'cloud' } })
                if (res.data.data.is_right || res.data.data.is_correct) {
                    console.log(`å°è¯•[${key + 1}/${ansList.length}] ${ansList[key]} æˆåŠŸ`)
                    showEl2.innerText = `å°è¯•[${key + 1}/${ansList.length}] ${ansList[key]} æˆåŠŸ`
                    break;
                } else {
                    console.log(`å°è¯•[${key + 1}/${ansList.length}] ${ansList[key]} å¤±è´¥`)
                    showEl2.innerText = `å°è¯•[${key + 1}/${ansList.length}] ${ansList[key]} å¤±è´¥`
                }
            }
        }

        // è¯·æ±‚é—´éš”
        function delay(time) {
            return new Promise((res, rej) => {
                setTimeout(() => {
                    res()
                }, time)
            })
        }

        // ç”Ÿæˆæ‰€æœ‰ç­”æ¡ˆç»„åˆ
        function ansArr(arr, isMultip) {
            let N = null, answerArr = arr.map(el => el.key);
            if (isMultip) {
                N = answerArr.length;
            } else {
                N = 1;
            }
            let newAns = [];
            if (N === 1) {
                newAns = newAns.concat(combine(answerArr, 1))
            } else {
                for (let i = 2; i <= N; i++) {
                    newAns = newAns.concat(combine(answerArr, i))
                }
            }
            return newAns;

            function combine(arr, N) {
                //å­˜æ”¾ç´¢å¼•å·
                let res = []
                //å­˜æ”¾æœ€åçš„ç»“æœ
                var stack = []
                arrayN(arr, 0, N, N, res, stack)
                // return pedding(stack); // å¦‚æœä¸‹é¢è¿”å›çš„ç­”æ¡ˆå…¨éƒ½ä¸å¯¹å†å¯ç”¨è¿™ä¸ª,ä¸Šé¢çš„å‡½æ•°ä¹Ÿè¦æ”¹
                return stack;
            }

            // ä¸­é—´æ–¹æ³•
            function pedding(arr) {
                let newArr = [];
                for (let key = 0; key < arr.length; key++) {
                    newArr.push(permute(arr[key]))
                }
                return newArr
            }

            // æ‰€æœ‰ç»„åˆæ–¹å¼
            function permute(input) {
                var permArr = [],
                    usedChars = [];
                function main(input) {
                    var i, ch;
                    for (i = 0; i < input.length; i++) {
                        ch = input.splice(i, 1)[0];
                        usedChars.push(ch);
                        if (input.length == 0) {
                            permArr.push(usedChars.slice());
                        }
                        main(input);
                        input.splice(i, 0, ch);
                        usedChars.pop();
                    }
                    return permArr
                }
                return main(input);
            };

            function arrayN(arr, start, count, Num, res, stack) {
                //ç”¨é€’å½’å®ç°ï¼ŒæŠŠNä¸ªå¾ªç¯ç”¨åŒä¸€ä¸ªå¾ªç¯å®ç°
                for (let i = start; i < arr.length - count + 1; i++) {
                    //è®°å½•ç´¢å¼•å·
                    res[count - 1] = i;
                    if (count - 1 == 0) {
                        let oneResult = []
                        for (let j = Num - 1; j >= 0; j--) {
                            oneResult.push(arr[res[j]])
                        }
                        stack.push(oneResult)
                    } else {
                        arrayN(arr, i + 1, count - 1, Num, res, stack)
                    }
                }
            }
        }

        listenAjax(exerciseList, ans);
    }

    // å­¦ä¹ å†…å®¹é¡µé¢
    function studycontentList() {
        showEl.innerText = "åŠ è½½å­¦ä¹ åˆ—è¡¨ä¸­";

        const learArr = [];
        let isLearArr = [];
        function reqs(data) {
            data.data.course_chapter.forEach(el => {
                if (!el.is_locked) {
                    el.section_leaf_list.forEach(el_ => {
                        if (el_.leaf_list) {
                            learArr.push(...el_.leaf_list)
                        } else {
                            learArr.push(el_)
                        }
                    })
                }
            });
            showEl.innerText = "è·å–åˆ°åˆ—è¡¨ï¼ŒæŸ¥è¯¢è¿›åº¦";
        }
        function prss(data) {
            const prssArr = data.data.leaf_schedules
            // æœªå®Œæˆåˆ—è¡¨
            const dontLear = learArr.filter(el => {
                const keys = Object.keys(prssArr)
                const findData = keys.find(i => +i === el.id);
                if (findData !== undefined) {
                    const learData = prssArr[findData]
                    if (learData !== undefined) {
                        if (typeof learData === "number") {
                            if (+learData !== 1) {
                                return true;
                            }
                        } else if (learData.total !== learData.done) {
                            return true;
                        }
                    } else {
                        return true;
                    }
                } else {
                    return true;
                }
            })
            showEl.innerText = "æŒ‚æœºæ‰§è¡Œä¸­...";
            startLears(dontLear.splice(0, 5))
        }
        function startLears(arr) {
            if (!arr.length) {
                showEl.innerText = "æ­å–œï¼Œæ‰€æœ‰è¯¾ç¨‹å‡å·²å®Œæˆï¼";
            }
            console.log("å¼€å§‹å­¦ä¹ è¿™äº›è¯¾ç¨‹", arr)
            const app = document.querySelector('[data-v-3d8fef40]').__vue__;
            const learEl = document.querySelectorAll(".learing-iframe-box .boxs")
            arr.forEach(el => {
                if (isLearArr.find(i => i.id === el.id) === undefined) {
                    const div = document.createElement("div");
                    div.classList.add("boxs");
                    div.setAttribute("lear-id", el.id)
                    div.setAttribute("pr-name", el.name)
                    const tempIFrame = document.createElement("iframe");
                    div.appendChild(tempIFrame)
                    if (el.leaf_type === 6) {
                        tempIFrame.src = `https://xidianyjs.yuketang.cn/pro/lms/${app.$data.sign}/${app.$data.classroom_id}/homework/${el.id}`
                    } else {
                        tempIFrame.src = `https://xidianyjs.yuketang.cn/pro/lms/${app.$data.sign}/${app.$data.classroom_id}/video/${el.id}`
                    }
                    tempIFrame.classList.add("learing-iframe");
                    document.querySelector(".learing-iframe-box").appendChild(div);
                    isLearArr.push(el.id);
                } else { }
            })
            isLearArr = arr;
            learEl.forEach(el => {
                const find = isLearArr.find(i => i.id === +el.getAttribute("lear-id"))
                if (find === undefined) {
                    console.log(el.getAttribute("pr-name"), "æ­¤è¯¾å·²å­¦ä¹ å®Œæˆ")
                    el.remove();
                }
            })
        }

        listenAjax(studyList, reqs);

        listenAjax(progress, prss);

        // å¾ªç¯
        function loop() {
            setTimeout(() => {
                console.log("æ›´æ–°åˆ—è¡¨")
                document.querySelector('[data-v-3d8fef40]').__vue__.getLearnSchedule();
                const learEl = document.querySelectorAll(".learing-iframe-box .boxs")
                if (learEl.length) {
                    loop()
                }
            }, 10000);
        }
        loop()
    }

    // è§†é¢‘æ’­æ”¾
    function playVideo() {
        showEl.innerText = `è§†é¢‘æ’­æ”¾æŒ‚æœºé¡µé¢ [ç­‰å¾…æ•è·è§†é¢‘url]`;

        const tims = setTimeout(() => {
            showEl.innerText = `é¡µé¢åŠ è½½é”™è¯¯ï¼Œæ­£åœ¨é‡è½½é¡µé¢`;
            setTimeout(() => {
                location.reload()
            }, 3000)
        }, 60000)

        function startListen(data) {
            clearTimeout(tims)
            console.log("è·å–åˆ°è§†é¢‘é“¾æ¥", data)
            let lastTime = null,
                reloadCount = 30,
                thisCount = 0
            showEl.innerText = `è§†é¢‘æ’­æ”¾æŒ‚æœºé¡µé¢ [ç­‰å¾…åˆ›å»ºvideoèŠ‚ç‚¹]`;
            function loop() {
                const video = document.querySelector("video")
                if (video) {
                    video.muted = true;
                    video.play()
                    const dur = parseInt(video.duration),
                        curr = parseInt(video.currentTime)
                    showEl.innerText = `è§†é¢‘æ’­æ”¾ä¸­ [${curr}/${dur}]`;
                    if (lastTime === curr) {
                        thisCount++;
                    } else {
                        thisCount = 0;
                    }
                    lastTime = curr;
                    if (reloadCount === thisCount) {
                        showEl.innerText = `è§†é¢‘é•¿æ—¶é—´æœªæ’­æ”¾ï¼Œæ­£åœ¨é‡è½½é¡µé¢`;
                        setTimeout(() => {
                            location.reload()
                        }, 3000)
                        return;
                    }
                }
                setTimeout(loop, 2000)
            }
            loop();
        }
        listenAjax(getVideoUrl, startListen);
    }

    // ajaxç›‘å¬
    function listenAjax(rule, callback) {

        // ç›‘å¬æ‰€æœ‰è¯·æ±‚
        const originOpen = XMLHttpRequest.prototype.open;
        const originSend = XMLHttpRequest.prototype.send;

        // é‡å†™open
        XMLHttpRequest.prototype.open = function () {
            this.addEventListener('load', function (obj) {
                const url = obj.target.responseURL; // obj.target -> this
                if (rule.test(url)) {
                    callback(JSON.parse(this.response))
                }
            });
            originOpen.apply(this, arguments);
        };

        // é‡å†™send
        XMLHttpRequest.prototype.send = function () {
            originSend.apply(this, arguments);
        };
    }
})();
